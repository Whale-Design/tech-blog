# 研究课题：从输入url到页面加载完成都发生了什么事情-前端视角
最近在搜索关于前端的一些面试题，发现有一个问题始终绕不开: ==在浏览器中输入URL到整个页面渲染完成这个过程中到底发生了什么==。仔细思考这个问题，发现确实里面的水很深，这个过程涉及到的东西也很多，在看了相关的一些文章之后做了如下的总结。  
总体来说主要分为以下几个过程:  
1. DNS解析  
2. TCP连接  
3. 发送HTTP请求  
4. 服务器处理请求并返回HTTP报文  
5. 浏览器解析渲染页面  
# 具体过程如下：

## 1，在浏览器中输入url
### URl---统一资源定位器（Uniform Resource Locators)
#### url定义  
url是从互联网上得到资源的位置和访问方法的一种简洁的表示，是互联网上标准资源的地址。  
互联网上每一个文件都有一个==唯一的==url,url可以由字母组成，如“baidu.com”,或者互联网协议（IP）地址：192.68.20.50。
#### url构成
##### scheme://host.domain:port/path/filename
1. scheme，协议部分，指访问服务器获取资源时要使用哪种协议，常用的协议有http,https（http+ssh）。
2. host.domain ，服务器主机地址，host是定义域主机（http的默认主机是www）domain是定义因特网域名。
3. port,端口，一般url中没有端口，因为服务器使用协议的默认端口。比如http协议默认端口：80。SSH默认端口：22。
4. path,路径，定义服务器上的路径，是访问的资源在服务器下的相对路径
5. filename，文件名称
## 2，浏览器查找域名的IP地址  
==导航的第一步就是确定访问域的IP地址，也就是通过DNS解析域名返回一个IP地址==
### DNS---域名系统（Domain Name System）
#### DNS定义
DNS是Internet的一项服务，将域名和IP地址相互映射的一个分布式数据库。  
引入域名是为了解决IP地址不便于记忆这个问题，所以就需要有DNS这样的服务来解决域名和IP地址是怎么映射的。  
要理解DNS,首先得知道域名，==域名==是为了识别主机名称和组织机构名称的一种具有分层的名称。
![image](http://s5.51cto.com/wyfs02/M00/4C/64/wKioL1Q8fyOxYPpVAADxqW8KTAM077.jpg)  
1. ==根域==：是上图中最顶部的那个，而对应的根域服务器有13台，目前是被编号为从A到M13个标号，他们只有13个IP地址，另外借由Anycast（任播技术，是一种网络定址和路由的策略，使得资料可以根据路由拓扑来决定送到“最近”或“最好”的目的地。）架设镜像服务器，使得实际运行的根域名服务器数量大大增加，标号相同的根服务器使用同一个IP。  
2. ==顶级域==：也叫一级域，主要分为四类：国家及地区顶级域（.cn, .jp等）、通用顶级域（.com, .edu, .net等）、基础设施顶级域（.arpa，之前属于通用顶级域）和测试顶级域。  
3. ==二级域==：可变长度的个体或组织，以便在Internet上使用的注册的名称，这些名称一定会基于相应的顶级域。  
4. 其他还有==三级域==（子域，也就是从已注册的二级域名自定义派生的），还可以有==四级域==（主机或资源名称）等等。  

### 域名解析过程  
#### 域名解析定义  

==域名解析==就是利用DNS解析器（进行DNS查询的主机或软件）得到对应IP的过程，解析器会向域名服务器进行查询处理。  
### DNS域名解析过程
1. ==浏览器缓存== -浏览器缓存DNS记录一段时间。有趣的是，操作系统不会告诉浏览器每个DNS记录的生存时间，因此浏览器会将它们缓存一段固定的时间。
2. ==操作系统缓存== -如果浏览器缓存不包含所需的记录，浏览器将进行系统调用（Windows中的gethostbyname）。操作系统也有自己的缓存。  
3. ==路由器缓存== - 请求继续到您的路由器，路由器通常有自己的DNS缓存。  
4. ==ISP DNS缓存== - 检查的下一个位置是缓存ISP的DNS服务器。  
5. ==递归搜索== - 您的ISP的DNS服务器开始递归搜索，从根名称服务器，通过.com顶级名称服务器，到Facebook的名称服务器。
![image](http://xdays.me/wp-content/uploads/2013/10/dns-procedure.gif)  
上图步骤如下：
- 用户电脑的解析器向LDNS（Local DNS）发起域名解析请求，查询www.google.com的IP地址，这是一个递归查找的过程  
- 在缓存没有命中的情况下，LDNS向根服务器查询www.google.com的IP地址，这是一个迭代查询的过程
- 根告诉LDNS，我不知道www.google.com对应的IP，但是我知道你可以问com域的授权DNS，这个域归他管
- LDNS向com的授权服务器问www.google.com对应的IP地址
- com告诉LDNS，我不知道www.google.com对应的IP，但是我知道你可以问google.com域的授权DNS，这个域归他管
- LDNS向google.com的授权服务器问www.google.com对应的IP地址
- google.com查询自己的zone文件（区域文件记录），找到了www.google.com对应的IP地址，返回给LDNS
- LDNS本地缓存一份记录，把结果返回给用户电脑的解析器  
- 在这之后，用户电脑的解析器拿到结果后，缓存在自己操作系统DNS缓存中，同时返回给浏览器，浏览器依旧会缓存一段时间。  
## 3，浏览器与服务器通过三次握手(SYN,SYN/ACK,ACK)建立TCP 连接 
### TCP  
#### TCP定义  
TCP是一种面向有连接的传输层协议。它可以保证两端（发送端和接收端）通信主机之间的通信可达。它能够处理在传输过程中丢包、传输顺序乱掉等异常情况；此外它还能有效利用宽带，缓解网络拥堵。  
==建立TCP连接==要经过三次握手，建立连接过程中会涉及TCP的标志位Flag，一共有6种标志：==SYN==(synchronize同步序号) ==ACK==(acknowledgement 确认) ==PSH==(push传送) ==FIN==(finish结束) ==RST==(reset重置) ==URG==(urgent紧急)，还有额外的两个号码：Sequence number(顺序号码) Acknowledge number(确认号码)  
![image](https://upload-images.jianshu.io/upload_images/3160413-5a9f596e6bde10c6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700)  
==三次握手过程:==
1. 第一次握手，请求建立连接，发送端发送连接请求报文，将SYN置为1，产生随机的顺序号seq=x
2. 第二次握手，接收端收到发送端发过来的报文，由SYN为1可知发送端现在要建立联机。然后接收端会向发送端发送一个SYN为1和ACK为x+1的报文，同时设置了自己随机产生的一个随机的顺序号seq=y
3. 第三次握手，发送端收到了发送过来的报文，需要检查一下返回的ACK是否是正确的（x+1）；若正确的话，发送端再次发送确认包，ACK为y+1，设置顺序号seq=x+1。  

发送端在收到接收端返回的ACK，确认后也就意味着连接成功了，就可以发送数据了；而接收端则必须等到发送端发送的ACK确认后才可以发送数据。在TCP连接建立完成之后就可以发送HTTP请求了  
## 4，浏览器向服务器发送HTTP请求  
#### HTTP定义  
HTTP（Hyper Text Transfer Protocol），是超文本传输协议的缩写。它主要是为了从Web服务器传输超文本到浏览器而设计的协议，由请求和响应构成。它是一种无连接的协议，也就意味着限制每次连接只处理一个请求，服务端处理完成且收到客户端应答后立即断开连接；同时也是无状态的，也就意味着没有记忆能力，每次连接都需要带上需要的信息。  
==发送HTTP请求的过程==就是构建HTTP请求报文并通过TCP协议发送到服务器指定端口。==HTTP请求报文==是由三部分组成: ==请求行==, ==请求报头==和==请求正文==。  
#### 请求行  
==请求行==以一个方法符号开头，以空格分开，后边跟着请求的URI以及协议版本号。  
格式：Method Request-URL HTTP-Version CRLF，例如 GET http://www.xxx.com/xx.html HTTP/1.1  
常用的请求方法：==GET==（获得指定URL的数据） ==POST==（请求服务器接收URI指定的文档作为可执行信息）==HEAD==（仅获取文档头部） ==PUT==（请求服务器保存客户端传送过来的数据到URI指定文档） ==DELETE==（请求服务器删除URI指定资源） ==TRACE==（请求消息返回客户端，主要用于测试或诊断） ==OPTIONS==（请求查询服务器性能或者查询与资源相关的选项和需求）  
#### 请求报头  
==请求报头==允许客户端向服务器传递请求的附加信息和客户端自身的信息。  
常见的请求报头有: ==Accept==（用于指定客户端用于接受哪些类型的信息）, ==Accept-Charset==（用于指定客户端接受的字符集。如果在请求消息中没有设置这个域，那就表示任何字符集都可以接受）, ==Accept-Encoding==（类似于Accept，但是它是用于指定可接受的内容编码。如果请求消息中没有设置这个域，那么服务器就假定客户端对各种内容编码都可以接受）, ==Accept-Language==（类似于Accept，但是它是用于指定一种自然语言，如果请求消息中没有设置这个报头域，服务器就假定客户端对各种语言都可以接受）, ==Content-Type==（报头域中所引用的媒体类型，必须采用相应的解码机制）, Authorization（主要用于证明客户端有权查看某个资源。当浏览器访问一个页面时，如果收到服务器的响应代码为401（未授权），可以发送一个包含Authorization请求报头域的请求，要求服务器对其进行验证）等。  
#### 请求正文  
当使用POST, PUT等方法时，通常需要客户端向服务器传递数据。这些数据就储存在请求正文中。  
## 5，服务器处理请求并返回HTTP报文  
服务器收到请求，从它的文档空间中查找资源，并返回HTTP响应报文。  
#### HTTP响应报文  
==HTTP响应报文==是由三部分组成: 状态码, 响应报头和响应报文。  
#### 状态码  
==状态码==是由3位数组成，第一个数字定义了响应的类别，且有五种可能取值。  

1xx：指示信息–表示请求已接收，继续处理。

2xx：成功–表示请求已被成功接收、理解、接受。

3xx：重定向–要完成请求必须进行更进一步的操作。

4xx：客户端错误–请求有语法错误或请求无法实现。

5xx：服务器端错误–服务器未能实现合法的请求。  
#### 响应报头  
常见的响应报头字段有: Server, Connection...。  
#### 响应报文  
服务器返回给浏览器的文本信息，通常HTML, CSS, JS, 图片等文件就放在这一部分。  
## 6，浏览器接受HTTP响应，检查 HTTP header 里的状态码，并做出不同的处理方式。  
比如404显示错误页面，304使用缓存，200下一步解码和渲染， 204页面不会发生更新。

## 7，如果是可以缓存的，这个响应则会被存储起来。  
根据首部字段判断是否进行缓存。例如，Cache-Control, no-cache(每次使用缓存前和服务器确认)，no-store 绝对禁止缓存  
## 8，解码
1. 浏览器拿到index.html文件后，就开始解析其中的html代码，遇到js/css/image等静态资源时，就向服务器端去请求下载  
2. 解析成对应的树形数据结构DOM树、CSS规则树，Javascript脚本通过DOM API和CSSOM API来操作DOM树、CSS规则树。  
## 9，渲染  
1. 计算CSS样式（JS可动态修改dom或css,进一步改变渲染树和分布）  
2. 构建渲染树（==Repaint（重绘）==：屏幕的一部分要重画，比如某个CSS的背景色变了，元素的几何尺寸没有变。==Reflow（回流）==：几何尺寸变了，我们需要重新验证并计算Render Tree。）  
3. 确认布局（定位坐标和大小，是否换行，各种position, overflow, z-index属性 ……）
4. 绘制（调用操作系统Native GUI的API绘制，将每个节点转化为实际像素绘制到视口上）  
## 10，关闭TCP连接  
通过四次挥手关闭连接(FIN ACK, ACK, FIN ACK, ACK)。  
![image](https://upload-images.jianshu.io/upload_images/3160413-1d8c843335a5f419.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700)  

第一次挥手是浏览器发完数据后，发送FIN请求断开连接。第二次挥手是服务器发送ACK表示同意，如果在这一次服务器也发送FIN请求断开连接似乎也没有不妥，但考虑到服务器可能还有数据要发送，所以服务器发送FIN应该放在第三次挥手中。这样浏览器需要返回ACK表示同意，也就是第四次挥手。

简而言之，一端断开连接需要两次挥手（请求和回应），两端断开连接就需要四次挥手。  

因为这篇文章涉及到的东西比较多，目前所涉及到的大部分内容，基本上是一笔带过，只是有一个浅显的认知，让我了解了从输入url到页面渲染完成的整个大致过程，希望下周继续研究。






